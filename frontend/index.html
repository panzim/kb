<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minimal Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 flex flex-col h-screen">

<!-- Header -->
<div class="bg-white border-b border-gray-200 px-6 py-4">
    <h1 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
        🤖 PANZIM Assistant
    </h1>
</div>

<!-- Messages -->
<div id="chat" class="flex-1 overflow-y-auto px-4 py-6 space-y-4">
    <!-- Messages will appear here -->
</div>

<!-- Input -->
<div class="bg-white border-t border-gray-200 px-4 py-4">
    <div class="flex items-end gap-3 max-w-4xl mx-auto">
    <textarea
            id="input"
            placeholder="Type your message..."
            rows="1"
            class="flex-1 px-4 py-3 pr-12 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"
            style="min-height:48px; max-height:120px; overflow-y:auto"
    ></textarea>
        <button
                id="sendBtn"
                class="flex-shrink-0 w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center transition-colors"
        >
            ➤
        </button>
    </div>
    <p class="text-xs text-gray-500 text-center mt-2">
        Press Enter to send, Shift+Enter for new line
    </p>
</div>

<script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");

    let messages = [];

    function addMessage(text, sender = "user", isError = false) {
      const wrapper = document.createElement("div");
      wrapper.className = `flex items-start gap-3 ${sender === "user" ? "flex-row-reverse" : ""}`;

      const bubble = document.createElement("div");
      bubble.className =
        sender === "user"
          ? "max-w-xs lg:max-w-2xl px-4 py-3 rounded-2xl bg-blue-600 text-white rounded-br-sm"
          : isError
            ? "max-w-xs lg:max-w-2xl px-4 py-3 rounded-2xl bg-red-100 text-red-800 border border-red-300 rounded-bl-sm"
            : "max-w-xs lg:max-w-2xl px-4 py-3 rounded-2xl bg-white text-gray-800 border border-gray-200 rounded-bl-sm";

      bubble.innerText = text;
      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;

      messages.push({ sender, text });
      return wrapper; // return to update later (for spinner)
    }

    function addSpinner() {
      const wrapper = document.createElement("div");
      wrapper.className = "flex items-start gap-3";

      const bubble = document.createElement("div");
      bubble.className =
        "max-w-xs lg:max-w-2xl px-4 py-3 rounded-2xl bg-white border border-gray-200 text-gray-500 rounded-bl-sm flex items-center";

      bubble.innerHTML = `
        <svg class="animate-spin h-5 w-5 text-gray-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        Thinking...
      `;
      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;

      return wrapper;
    }

    async function initChat() {
      try {
        if (!document.cookie.includes("krisp-session")) {
          const res = await fetch("/session", { method: "POST", credentials: "include"});
          if (!res.ok) {
            addMessage("❌ Failed to start session", "bot", true);
          }
        }

        const res = await fetch("/history", { credentials: "include" });
        if (res.ok) {
          const history = await res.json();
          history.forEach((m) => addMessage(m.text, m.sender));
        } else {
          addMessage("❌ Failed to load history", "bot", true);
        }
      } catch (err) {
        addMessage("❌ Error initializing chat: " + err.message, "bot", true);
      }
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, "user");
      input.value = "";

      const spinner = addSpinner();

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ "user_message": text }),
          signal: controller.signal,
        });

        clearTimeout(timeoutId);
        spinner.remove();

        if (res.ok) {
          const data = await res.json();
          if (data.reply) {
            addMessage(data.reply, "bot");
          } else {
            addMessage("Server returned no reply", "bot", true);
          }
        } else {
          const errText = await res.text();
          addMessage(`❌ Error ${res.status}: ${errText}`, "bot", true);
        }
      } catch (err) {
        clearTimeout(timeoutId);
        spinner.remove();
        if (err.name === "AbortError") {
          addMessage("❌ No response from server", "bot", true);
        } else {
          addMessage("❌ Error: " + err.message, "bot", true);
        }
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    initChat();
</script>
</body>
</html>
